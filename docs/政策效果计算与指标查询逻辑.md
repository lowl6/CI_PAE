# 政策效果计算与指标查询逻辑文档

## 概述

本文档详细说明了 CI-PAE 系统中政策效果指数的计算逻辑和相关领域指标的查询机制。

---

## 一、政策关联强度 (Strength) 计算

### 1.1 数据来源
- **表**: `rel_policy_county` (政策-县区关联表)
- **字段**: `strength` (DECIMAL(3,2), 范围 0-1)
- **计算时机**: 数据库初始化时，通过迁移脚本 `add_policy_enhancements.sql` 自动计算

### 1.2 计算公式

政策关联强度综合考虑 **4个维度** 的指标变化，对比政策发布前后的数据变化率：

```
strength = 经济维度(40%) + 农业维度(30%) + 基础设施维度(20%) + 社会保障维度(10%)
```

#### 1.2.1 经济增长维度 (40% 权重)

**计算逻辑**:
- **时间窗口**: 政策发布前2年 vs 政策发布后1-3年
- **指标权重**: GDP增长率(50%) + 农村居民收入增长率(50%)

```sql
经济维度分数 = 0.40 × (
  0.50 × GDP增长率归一化值 + 
  0.50 × 农村居民收入增长率归一化值
)

-- GDP增长率归一化: 15%增长率 = 1.0分
-- 收入增长率归一化: 10%增长率 = 1.0分
```

**数据来源表**: `economic_indicators`
- `gdp`: 地区生产总值
- `disp_income_rural`: 农村牧区常住居民人均可支配收入

#### 1.2.2 农业发展维度 (30% 权重)

**计算逻辑**:
- **时间窗口**: 政策发布前2年 vs 政策发布后1-3年
- **指标权重**: 粮食产量增长(67%) + 耕地面积变化(33%)

```sql
农业维度分数 = 0.30 × (
  0.67 × 粮食产量增长率归一化值 + 
  0.33 × 耕地面积增长率归一化值
)

-- 粮食产量归一化: 8%增长率 = 1.0分
-- 耕地面积归一化: 5%增长率 = 1.0分 (负增长映射到0-0.5)
```

**数据来源表**: `agriculture_indicators`
- `grain_yield`: 粮食产量 (吨)
- `arable_land`: 耕地面积 (公顷)

#### 1.2.3 基础设施维度 (20% 权重)

**计算逻辑**:
- **时间窗口**: 政策发布前2年 vs 政策发布后1-3年
- **指标权重**: 公路里程增长(50%) + 宽带用户增长(50%)

```sql
基础设施维度分数 = 0.20 × (
  0.50 × 公路里程增长率归一化值 + 
  0.50 × 宽带用户增长率归一化值
)

-- 公路里程归一化: 6%增长率 = 1.0分
-- 宽带用户归一化: 20%增长率 = 1.0分
```

**数据来源表**: `infrastructure_indicators`
- `road_mileage`: 公路里程 (公里)
- `broadband_users`: 互联网宽带接入用户 (户)

#### 1.2.4 社会保障维度 (10% 权重)

**计算逻辑**:
- **时间窗口**: 政策发布前2年 vs 政策发布后1-3年
- **指标权重**: 医疗床位增长(50%) + 医保参保人数增长(50%)

```sql
社会保障维度分数 = 0.10 × (
  0.50 × 医疗床位增长率归一化值 + 
  0.50 × 医保参保人数增长率归一化值
)

-- 医疗床位归一化: 8%增长率 = 1.0分
-- 医保参保归一化: 5%增长率 = 1.0分
```

**数据来源表**: `medical_social_indicators`
- `medical_beds`: 医疗卫生机构床位数 (张)
- `medical_insurance_users`: 基本医疗保险参保人数 (人)

### 1.3 最终归一化

```sql
final_strength = GREATEST(0.20, LEAST(0.95, 
  经济维度分数 + 农业维度分数 + 基础设施维度分数 + 社会保障维度分数
))
```

- **最小值**: 0.20 (避免过低的无效数据)
- **最大值**: 0.95 (避免饱和)

---

## 二、政策效果指数计算 (前端展示)

### 2.1 数据来源
- **后端API**: `/api/compare/data`
- **返回字段**: `policyEffect` 数组，包含每年每个县区的平均 strength 值

### 2.2 计算逻辑

在 `Compare.vue` 中，政策效果指数从 0-1 的 strength 值转换为 0-100 的综合评分：

```javascript
政策效果指数 = 基础分 + 趋势加成 + 完整度加成

基础分 = 平均strength × 100  // 0-100分

趋势加成 = 改善率 × 趋势系数  // ±20分
  改善率 = ((后半段平均 - 前半段平均) / 前半段平均) × 100%
  
完整度加成 = min(10, 数据点数量 × 2)  // 0-10分
```

**示例计算**:
```javascript
// 某县区政策效果数据: [0.65, 0.68, 0.70, 0.72, 0.75]
平均strength = 0.70
前半段平均 = (0.65 + 0.68) / 2 = 0.665
后半段平均 = (0.72 + 0.75) / 2 = 0.735
改善率 = (0.735 - 0.665) / 0.665 × 100% = 10.5%

基础分 = 0.70 × 100 = 70分
趋势加成 = min(20, max(-20, 10.5)) = 10.5分
完整度加成 = min(10, 5 × 2) = 10分

最终指数 = 70 + 10.5 + 10 = 90.5分
```

### 2.3 分级着色

```javascript
政策效果指数评级:
- 80-100分: 深绿 (#52c41a) - 优秀
- 60-80分:  浅绿 (#73d13d) - 良好
- 40-60分:  蓝色 (#1890ff) - 中等
- 20-40分:  橙色 (#fa8c16) - 较差
- 0-20分:   红色 (#ff4d4f) - 差
```

---

## 三、相关领域指标查询

### 3.1 政策类型到指标映射

在 `compareController.js` 中定义了政策类型与指标的对应关系：

| 政策类型 | 相关指标 | 数据表 |
|---------|---------|--------|
| **经济发展** | GDP (亿元) | `economic_indicators` |
| | 财政收入 (万元) | `economic_indicators` |
| | 农村居民收入 (元) | `economic_indicators` |
| **农业扶贫** | 粮食产量 (吨) | `agriculture_indicators` |
| | 耕地面积 (公顷) | `agriculture_indicators` |
| | 播种面积 (公顷) | `agriculture_indicators` |
| **社会保障与就业** | 医疗床位 (张) | `medical_social_indicators` |
| | 医保参保人数 (人) | `medical_social_indicators` |
| | 居民人均收入 (元) | `economic_indicators` |
| **基础设施建设** | 公路里程 (公里) | `infrastructure_indicators` |
| | 移动电话用户 (户) | `infrastructure_indicators` |
| | 宽带用户 (户) | `infrastructure_indicators` |
| **教育文化** | 小学数量 (所) | `edu_culture_indicators` |
| | 中学数量 (所) | `edu_culture_indicators` |
| | 专利授权 (件) | `edu_culture_indicators` |
| **工业招商** | 规上工业企业 (个) | `industry_trade_indicators` |
| | 零售总额 (万元) | `industry_trade_indicators` |
| | 出口总额 (万元) | `industry_trade_indicators` |

### 3.2 查询逻辑

#### 3.2.1 后端查询流程

```javascript
function getRelatedIndicators(regionIds, startYear, endYear, policyTypes) {
  // 1. 根据政策类型收集所有需要查询的指标
  const allIndicators = []
  policyTypes.forEach(type => {
    const indicators = policyIndicatorMap[type]
    if (indicators) {
      allIndicators.push(...indicators)  // 去重处理
    }
  })
  
  // 2. 按数据表分组查询
  const tableGroups = groupBy(allIndicators, 'table')
  
  // 3. 对每个表执行查询
  for (const [table, indicators] of Object.entries(tableGroups)) {
    const fields = indicators.map(ind => ind.field).join(', ')
    
    const sql = `
      SELECT year, county_id, ${fields}
      FROM ${table}
      WHERE county_id IN (${regionIds.join(',')})
      AND year BETWEEN ${startYear} AND ${endYear}
      ORDER BY year, county_id
    `
    
    const rows = await pool.query(sql)
    
    // 4. 构造返回数据结构
    indicators.forEach(indicator => {
      const indicatorData = {
        name: indicator.name,
        unit: indicator.unit,
        data: transformToTimeSeriesFormat(rows, indicator.field, regionIds)
      }
      result.push(indicatorData)
    })
  }
  
  return result
}
```

#### 3.2.2 数据结构转换

**原始数据**:
```javascript
[
  { year: 2015, county_id: 'NMG000001', gdp: 120.5 },
  { year: 2015, county_id: 'NMG000002', gdp: 98.3 },
  { year: 2016, county_id: 'NMG000001', gdp: 135.2 },
  { year: 2016, county_id: 'NMG000002', gdp: 105.7 }
]
```

**转换后的时间序列格式**:
```javascript
{
  name: 'GDP',
  unit: '亿元',
  data: [
    { year: 2015, region1: 120.5, region2: 98.3 },
    { year: 2016, region1: 135.2, region2: 105.7 }
  ]
}
```

### 3.3 前端图表展示

在 `RelatedIndicatorChart.vue` 中使用 ECharts 绘制折线图：

```javascript
const option = {
  tooltip: {
    trigger: 'axis',
    axisPointer: { type: 'shadow' }
  },
  legend: {
    data: ['县区1', '县区2'],
    bottom: 0
  },
  xAxis: {
    type: 'category',
    data: ['2015', '2016', '2017', ...]  // 年份
  },
  yAxis: {
    type: 'value',
    name: '指标名称 (单位)'
  },
  series: [
    {
      name: '县区1',
      type: 'line',
      smooth: true,
      data: [120.5, 135.2, ...],
      areaStyle: { opacity: 0.1 }  // 半透明面积图
    },
    {
      name: '县区2',
      type: 'line',
      smooth: true,
      data: [98.3, 105.7, ...],
      areaStyle: { opacity: 0.1 }
    }
  ]
}
```

---

## 四、关键SQL查询示例

### 4.1 政策效果强度查询

```sql
-- 查询某个县区在某时间段的政策平均强度
SELECT 
  YEAR(p.issue_date) as year,
  AVG(rpc.strength) as avg_strength
FROM policies p
JOIN rel_policy_county rpc ON p.policy_id = rpc.policy_id
WHERE rpc.county_id = 'NMG000001'
AND p.issue_date BETWEEN '2015-01-01' AND '2023-12-31'
AND p.policy_type = '经济发展'  -- 可选的政策类型过滤
GROUP BY YEAR(p.issue_date)
ORDER BY year;
```

### 4.2 多县区对比查询

```sql
-- 对比两个县区的政策效果
SELECT 
  YEAR(p.issue_date) as year,
  AVG(CASE WHEN rpc.county_id = 'NMG000001' THEN rpc.strength END) as region1,
  AVG(CASE WHEN rpc.county_id = 'NMG000002' THEN rpc.strength END) as region2
FROM policies p
JOIN rel_policy_county rpc ON p.policy_id = rpc.policy_id
WHERE rpc.county_id IN ('NMG000001', 'NMG000002')
AND p.issue_date BETWEEN '2015-01-01' AND '2023-12-31'
GROUP BY YEAR(p.issue_date)
ORDER BY year;
```

### 4.3 相关指标查询

```sql
-- 查询经济发展类政策的相关指标
SELECT 
  ei.year,
  ei.county_id,
  ei.gdp,
  ei.public_budget_income,
  ei.disp_income_rural
FROM economic_indicators ei
WHERE ei.county_id IN ('NMG000001', 'NMG000002')
AND ei.year BETWEEN 2015 AND 2023
ORDER BY ei.year, ei.county_id;
```

---

## 五、数据流程图

```
┌─────────────────┐
│ 数据库初始化     │
│ (initDb.js)     │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 迁移脚本执行                         │
│ (add_policy_enhancements.sql)       │
│                                     │
│ 1. 添加 strength 字段                │
│ 2. 基于4维度指标计算strength         │
│    - 对比政策前后指标变化            │
│    - 加权求和得到 0.2-0.95 范围值    │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ rel_policy_county 表                 │
│ ┌─────────────────────────────────┐ │
│ │ policy_id │ county_id │ strength││ │
│ ├───────────┼───────────┼─────────┤│ │
│ │ POL001    │ NMG000001 │ 0.92    ││ │
│ │ POL001    │ NMG000002 │ 0.87    ││ │
│ └─────────────────────────────────┘ │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 后端API查询                          │
│ (compareController.js)              │
│                                     │
│ 1. 查询政策效果 (strength平均值)     │
│ 2. 根据政策类型查询相关指标          │
│ 3. 数据格式转换为时间序列            │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 前端处理                             │
│ (Compare.vue)                       │
│                                     │
│ 1. 计算政策效果指数 (0-100分)        │
│    - 基础分 = strength × 100        │
│    - 趋势加成 (±20分)               │
│    - 完整度加成 (0-10分)            │
│                                     │
│ 2. 渲染图表                         │
│    - 政策效果柱状图                 │
│    - 相关指标折线图                 │
└─────────────────────────────────────┘
```

---

## 六、性能优化建议

### 6.1 数据库索引

```sql
-- 政策效果查询优化
CREATE INDEX idx_policy_issue_date ON policies(issue_date);
CREATE INDEX idx_rel_county_policy ON rel_policy_county(county_id, policy_id);

-- 指标查询优化
CREATE INDEX idx_economic_county_year ON economic_indicators(county_id, year);
CREATE INDEX idx_agriculture_county_year ON agriculture_indicators(county_id, year);
CREATE INDEX idx_infrastructure_county_year ON infrastructure_indicators(county_id, year);
CREATE INDEX idx_medical_county_year ON medical_social_indicators(county_id, year);
```

### 6.2 查询缓存

建议在前端或后端实现查询结果缓存，避免重复计算：

```javascript
// 简单的内存缓存示例
const queryCache = new Map();

function getCachedData(key, queryFn, ttl = 300000) {  // 5分钟缓存
  const cached = queryCache.get(key);
  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data;
  }
  
  const data = queryFn();
  queryCache.set(key, { data, timestamp: Date.now() });
  return data;
}
```

---

## 七、常见问题

### Q1: 为什么 strength 范围是 0.2-0.95 而不是 0-1？
**A**: 
- 最小值 0.2：避免极端低值导致的数据失真，保证所有政策都有基础效果
- 最大值 0.95：避免数值饱和，为特殊优秀案例预留空间

### Q2: 政策效果指数的趋势加成如何计算？
**A**: 对比时间序列的前半段和后半段平均值，计算改善率：
```
改善率 = (后半段平均 - 前半段平均) / 前半段平均 × 100%
趋势加成 = max(-20, min(20, 改善率))
```

### Q3: 如何添加新的政策类型和指标？
**A**: 
1. 在 `compareController.js` 的 `policyIndicatorMap` 中添加映射关系
2. 确保对应的指标字段在数据表中存在
3. 前端 `Compare.vue` 的政策类型下拉框中添加新选项

---

## 八、版本历史

| 版本 | 日期 | 修改内容 |
|-----|------|---------|
| 1.0 | 2025-01-27 | 初始版本，基于真实指标计算政策效果强度 |
| 1.1 | 2025-01-27 | 添加相关领域指标查询功能 |
| 1.2 | 2025-01-27 | 政策类型改为单选，优化用户体验 |

---

## 九、相关文件

- **后端迁移脚本**: `backend/database/migrations/add_policy_enhancements.sql`
- **后端控制器**: `backend/controllers/compareController.js`
- **前端对比页面**: `frontend/src/views/Compare.vue`
- **前端图表组件**: 
  - `frontend/src/components/Charts/PolicyEffectChart.vue`
  - `frontend/src/components/Charts/RelatedIndicatorChart.vue`
